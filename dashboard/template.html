<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Accidents du Travail par Secteur | Ameli 2023</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #0f1419;
    --bg-elevated: #161b22;
    --bg-card: #1c2128;
    --border: #2d333b;
    --border-light: #373e47;
    --text: #e6edf3;
    --text-secondary: #8b949e;
    --text-dim: #545d68;
    --accent: #d4a043;
    --accent-glow: rgba(212,160,67,0.12);
    --danger: #e5534b;
    --danger-dim: rgba(229,83,75,0.15);
    --safe: #3fb950;
    --safe-dim: rgba(63,185,80,0.15);
    --mono: 'JetBrains Mono', 'SF Mono', monospace;
    --serif: 'DM Serif Display', Georgia, serif;
    --sans: 'DM Sans', -apple-system, sans-serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: var(--sans);
    background: var(--bg);
    color: var(--text);
    line-height: 1.55;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
  }

  /* Subtle noise texture */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 1100px;
    margin: 0 auto;
    padding: 48px 24px 80px;
  }

  /* ===== HEADER ===== */
  header {
    margin-bottom: 48px;
    padding-bottom: 32px;
    border-bottom: 1px solid var(--border);
  }
  .header-eyebrow {
    font-family: var(--mono);
    font-size: 0.7rem;
    font-weight: 500;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 12px;
  }
  header h1 {
    font-family: var(--serif);
    font-size: 2.4rem;
    font-weight: 400;
    line-height: 1.15;
    letter-spacing: -0.01em;
    color: var(--text);
    margin-bottom: 8px;
  }
  header p {
    color: var(--text-secondary);
    font-size: 0.92rem;
    font-weight: 300;
  }

  /* ===== SEARCH ===== */
  .search-section {
    margin-bottom: 40px;
    position: sticky;
    top: 0;
    z-index: 50;
    background: var(--bg);
    padding: 12px 0;
    margin-left: -24px;
    margin-right: -24px;
    padding-left: 24px;
    padding-right: 24px;
  }
  .search-row {
    display: flex;
    gap: 12px;
    align-items: stretch;
  }
  .search-wrapper {
    flex: 1;
    position: relative;
  }
  .search-wrapper input {
    width: 100%;
    padding: 14px 16px 14px 44px;
    border: 1px solid var(--border);
    border-radius: 2px;
    font-family: var(--mono);
    font-size: 0.88rem;
    font-weight: 400;
    background: var(--bg-elevated);
    color: var(--text);
    transition: border-color 0.2s, box-shadow 0.2s;
    outline: none;
  }
  .search-wrapper input::placeholder { color: var(--text-dim); }
  .search-wrapper input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }
  .search-wrapper .icon {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-dim);
    font-size: 0.9rem;
    pointer-events: none;
    font-family: var(--sans);
  }

  /* Autocomplete */
  .autocomplete {
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    right: 0;
    background: var(--bg-card);
    border: 1px solid var(--border-light);
    border-radius: 2px;
    max-height: 360px;
    overflow-y: auto;
    z-index: 100;
    display: none;
    box-shadow: 0 12px 40px rgba(0,0,0,0.5);
  }
  .autocomplete.open { display: block; }
  .autocomplete::-webkit-scrollbar { width: 6px; }
  .autocomplete::-webkit-scrollbar-track { background: transparent; }
  .autocomplete::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 3px; }
  .ac-item {
    padding: 10px 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    border-bottom: 1px solid var(--border);
    transition: background 0.1s;
  }
  .ac-item:last-child { border-bottom: none; }
  .ac-item:hover, .ac-item.active { background: var(--accent-glow); }
  .ac-item .code {
    font-family: var(--mono);
    font-weight: 600;
    font-size: 0.82rem;
    color: var(--accent);
    min-width: 54px;
  }
  .ac-item .libelle {
    color: var(--text-secondary);
    font-size: 0.82rem;
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .ac-item .level-tag {
    font-family: var(--mono);
    font-size: 0.65rem;
    font-weight: 500;
    letter-spacing: 0.05em;
    padding: 2px 6px;
    border: 1px solid var(--border-light);
    border-radius: 2px;
    color: var(--text-dim);
    flex-shrink: 0;
  }

  /* Level tabs */
  .level-tabs { display: flex; gap: 2px; }
  .level-tabs button {
    padding: 14px 20px;
    border: 1px solid var(--border);
    border-radius: 2px;
    background: var(--bg-elevated);
    font-family: var(--mono);
    font-size: 0.78rem;
    font-weight: 500;
    letter-spacing: 0.04em;
    cursor: pointer;
    transition: all 0.15s;
    color: var(--text-dim);
  }
  .level-tabs button:hover { color: var(--text-secondary); border-color: var(--border-light); }
  .level-tabs button.active {
    background: var(--accent);
    color: var(--bg);
    border-color: var(--accent);
    font-weight: 600;
  }

  /* ===== RESULTS ===== */
  #results { display: none; }
  #results.visible { display: block; animation: fadeUp 0.35s ease-out; }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Selection header */
  .selection-header {
    margin-bottom: 32px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }
  .selection-header h2 {
    font-family: var(--serif);
    font-size: 1.65rem;
    font-weight: 400;
    line-height: 1.2;
    margin-bottom: 4px;
  }
  .selection-header .sub {
    font-family: var(--mono);
    font-size: 0.75rem;
    color: var(--text-dim);
    letter-spacing: 0.02em;
  }

  /* ===== KPI GRID ===== */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1px;
    background: var(--border);
    margin-bottom: 40px;
    border: 1px solid var(--border);
  }
  .kpi-card {
    background: var(--bg-elevated);
    padding: 24px;
  }
  .kpi-card .label {
    font-family: var(--mono);
    font-size: 0.68rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 8px;
  }
  .kpi-card .value {
    font-family: var(--serif);
    font-size: 2rem;
    font-weight: 400;
    line-height: 1.1;
    color: var(--text);
  }
  .kpi-card .badge {
    display: inline-block;
    margin-top: 8px;
    padding: 3px 8px;
    font-family: var(--mono);
    font-size: 0.72rem;
    font-weight: 500;
    border-radius: 2px;
  }
  .badge.up { background: var(--danger-dim); color: var(--danger); }
  .badge.down { background: var(--safe-dim); color: var(--safe); }
  .badge.neutral { background: rgba(139,148,158,0.1); color: var(--text-secondary); }

  /* ===== CHARTS ===== */
  .charts-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 24px;
  }
  .chart-card {
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    padding: 24px;
  }
  .chart-card h3 {
    font-family: var(--mono);
    font-size: 0.72rem;
    font-weight: 500;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 20px;
  }
  .chart-card .chart-wrap {
    position: relative;
    width: 100%;
  }

  /* Comparison */
  .comparison-card {
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    padding: 24px;
  }
  .comparison-card h3 {
    font-family: var(--mono);
    font-size: 0.72rem;
    font-weight: 500;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 20px;
  }

  /* ===== INSIGHTS ===== */
  .insights-panel {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 24px;
  }
  .insights-panel:empty { display: none; }
  .insight {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 14px;
    border-radius: 3px;
    font-size: 0.8rem;
    line-height: 1.3;
    color: var(--text);
  }
  .insight .insight-icon {
    font-size: 0.9rem;
    flex-shrink: 0;
  }
  .insight.warn {
    background: rgba(212,160,67,0.1);
    border: 1px solid rgba(212,160,67,0.25);
  }
  .insight.warn .insight-icon { color: var(--accent); }
  .insight.danger {
    background: var(--danger-dim);
    border: 1px solid rgba(229,83,75,0.25);
  }
  .insight.danger .insight-icon { color: var(--danger); }
  .insight.info {
    background: rgba(78,138,197,0.1);
    border: 1px solid rgba(78,138,197,0.25);
  }
  .insight.info .insight-icon { color: #4e8ac5; }

  /* ===== POSITION STRIP ===== */
  .position-card {
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    padding: 24px;
    margin-bottom: 24px;
  }
  .position-card h3 {
    font-family: var(--mono);
    font-size: 0.72rem;
    font-weight: 500;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 16px;
  }
  .pos-strip-wrap {
    position: relative;
    height: 80px;
  }
  .pos-track {
    position: absolute;
    top: 28px;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
  }
  .pos-dot {
    position: absolute;
    top: 19px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--border-light);
    transform: translateX(-50%);
    opacity: 0.5;
    cursor: pointer;
    transition: opacity 0.15s, transform 0.15s;
    z-index: 1;
  }
  .pos-dot:hover {
    opacity: 1;
    transform: translateX(-50%) scale(1.6);
    background: var(--text-secondary);
    z-index: 3;
  }
  .pos-dot.current {
    width: 18px;
    height: 18px;
    top: 16px;
    background: var(--accent);
    opacity: 1;
    z-index: 2;
    cursor: default;
    box-shadow: 0 0 0 3px var(--accent-glow);
  }
  .pos-dot.current:hover { transform: translateX(-50%) scale(1); }
  .pos-tip {
    position: absolute;
    background: var(--bg-card);
    border: 1px solid var(--border-light);
    border-radius: 3px;
    padding: 6px 10px;
    font-family: var(--mono);
    font-size: 0.72rem;
    color: var(--text);
    pointer-events: none;
    z-index: 10;
    white-space: nowrap;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    opacity: 0;
    transition: opacity 0.12s;
    bottom: 60px;
    transform: translateX(-50%);
  }
  .pos-tip.visible { opacity: 1; }
  .pos-marker-label {
    position: absolute;
    top: 44px;
    transform: translateX(-50%);
    font-family: var(--mono);
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--accent);
    white-space: nowrap;
  }
  .pos-national {
    position: absolute;
    top: 8px;
    width: 2px;
    height: 34px;
    background: var(--danger);
    opacity: 0.7;
    transform: translateX(-50%);
    z-index: 1;
  }
  .pos-national-label {
    position: absolute;
    top: -2px;
    transform: translateX(-50%);
    font-family: var(--mono);
    font-size: 0.62rem;
    font-weight: 500;
    color: var(--danger);
    white-space: nowrap;
    opacity: 0.8;
  }
  .pos-axis {
    position: absolute;
    top: 6px;
    transform: translateX(-50%);
    font-family: var(--mono);
    font-size: 0.62rem;
    color: var(--text-dim);
  }
  .pos-axis.pos-end { transform: translateX(0); right: 0; left: auto; }

  /* ===== FUNNEL ===== */
  .funnel {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    padding: 20px 0 8px;
  }
  .funnel-bar {
    border-radius: 4px;
    height: 52px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: opacity 0.15s;
    min-width: 52px;
    cursor: default;
  }
  .funnel-bar:hover { opacity: 0.85; }
  .funnel-bar-label {
    font-size: 0.82rem;
    font-weight: 500;
    color: rgba(255,255,255,0.92);
    white-space: nowrap;
  }
  .funnel-bar-value {
    font-family: var(--mono);
    font-size: 0.82rem;
    font-weight: 700;
    color: #fff;
    white-space: nowrap;
  }
  .funnel-tooltip {
    position: absolute;
    background: var(--bg-card);
    border: 1px solid var(--border-light);
    border-radius: 3px;
    padding: 8px 12px;
    font-family: var(--mono);
    font-size: 0.75rem;
    color: var(--text);
    pointer-events: none;
    z-index: 10;
    white-space: nowrap;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    opacity: 0;
    transition: opacity 0.15s;
  }
  .funnel-tooltip.visible { opacity: 1; }
  .funnel-tooltip .tt-pct { color: var(--text-secondary); margin-left: 4px; }

  /* ===== EMPTY STATE ===== */
  .empty-state {
    padding: 64px 0;
  }
  .empty-inner {
    max-width: 600px;
    margin: 0 auto;
  }
  .empty-lead {
    font-family: var(--sans);
    font-size: 0.95rem;
    font-weight: 300;
    color: var(--text-secondary);
    line-height: 1.6;
    text-align: center;
    margin-bottom: 40px;
  }
  .naf-table {
    display: flex;
    flex-direction: column;
    border: 1px solid var(--border);
    background: var(--bg-elevated);
  }
  .naf-row {
    display: grid;
    grid-template-columns: 56px 1fr auto 1fr;
    align-items: center;
    gap: 16px;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.15s;
  }
  .naf-row:last-child { border-bottom: none; }
  .naf-row:hover { background: var(--accent-glow); }
  .naf-badge {
    font-family: var(--mono);
    font-size: 0.72rem;
    font-weight: 600;
    letter-spacing: 0.04em;
    color: var(--accent);
  }
  .naf-desc {
    font-size: 0.84rem;
    color: var(--text-secondary);
  }
  .naf-example {
    font-family: var(--mono);
    font-size: 0.84rem;
    font-weight: 600;
    color: var(--text);
    text-align: right;
  }
  .naf-label {
    font-size: 0.82rem;
    color: var(--text-dim);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* ===== FOOTER ===== */
  footer {
    margin-top: 48px;
    padding-top: 24px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.75rem;
    color: var(--text-dim);
  }
  footer a { color: var(--text-secondary); text-decoration: none; transition: color 0.15s; }
  footer a:hover { color: var(--accent); }

  /* ===== BREADCRUMB ===== */
  .breadcrumb {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
    margin-bottom: 8px;
  }
  .breadcrumb a {
    font-family: var(--mono);
    font-size: 0.75rem;
    color: var(--text-dim);
    text-decoration: none;
    transition: color 0.15s;
    cursor: pointer;
  }
  .breadcrumb a:hover { color: var(--accent); }
  .breadcrumb .sep {
    font-size: 0.65rem;
    color: var(--border-light);
  }
  .breadcrumb .current {
    font-family: var(--mono);
    font-size: 0.75rem;
    color: var(--text-secondary);
    font-weight: 600;
  }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 768px) {
    .container { padding: 24px 16px 60px; }
    header h1 { font-size: 1.65rem; }
    .search-row { flex-direction: column; }
    .level-tabs { justify-content: stretch; }
    .level-tabs button { flex: 1; text-align: center; }
    .kpi-grid { grid-template-columns: repeat(2, 1fr); }
    .charts-row { grid-template-columns: 1fr; }
    .kpi-card .value { font-size: 1.5rem; }
    footer { flex-direction: column; gap: 8px; text-align: center; }
  }
</style>
</head>
<body>

<div class="container">
  <header>
    <div class="header-eyebrow">Ameli Open Data 2023</div>
    <h1>Accidents du Travail par Secteur</h1>
    <p>Statistiques de sinistralite par code NAF. 729 secteurs, 19,3M salaries.</p>
  </header>

  <div class="search-section">
    <div class="search-row">
      <div class="search-wrapper">
        <span class="icon">/</span>
        <input type="text" id="searchInput" placeholder="code NAF ou activite..." autocomplete="off">
        <div class="autocomplete" id="autocomplete"></div>
      </div>
      <div class="level-tabs" id="levelTabs">
        <button data-level="naf5" class="active">NAF5</button>
        <button data-level="naf4">NAF4</button>
        <button data-level="naf2">NAF2</button>
      </div>
    </div>
  </div>

  <div class="empty-state" id="emptyState">
    <div class="empty-inner">
      <p class="empty-lead">Tapez un code NAF ou un mot-cle pour explorer<br>la sinistralite d'un secteur d'activite.</p>
      <div class="naf-table">
        <div class="naf-row">
          <span class="naf-badge">NAF5</span>
          <span class="naf-desc">Activite precise</span>
          <span class="naf-example" data-code="4711D">4711D</span>
          <span class="naf-label">Supermarches</span>
        </div>
        <div class="naf-row">
          <span class="naf-badge">NAF4</span>
          <span class="naf-desc">Sous-classe agregee</span>
          <span class="naf-example" data-code="4711">4711</span>
          <span class="naf-label">Commerce d'alimentation generale</span>
        </div>
        <div class="naf-row">
          <span class="naf-badge">NAF2</span>
          <span class="naf-desc">Division sectorielle</span>
          <span class="naf-example" data-code="47">47</span>
          <span class="naf-label">Commerce de detail</span>
        </div>
      </div>
    </div>
  </div>

  <div id="results">
    <div class="selection-header">
      <div class="breadcrumb" id="breadcrumb"></div>
      <h2 id="selTitle"></h2>
      <div class="sub" id="selSub"></div>
    </div>

    <div class="kpi-grid" id="kpiGrid"></div>

    <div class="insights-panel" id="insightsPanel"></div>

    <div class="position-card" id="positionCard">
      <h3 id="posTitle">Positionnement IF</h3>
      <div class="pos-strip-wrap" id="posStrip"></div>
    </div>

    <div class="charts-row">
      <div class="chart-card">
        <h3>Causes d'accidents</h3>
        <div class="chart-wrap" id="causesWrap" style="height:320px"><canvas id="causesChart"></canvas></div>
      </div>
      <div class="chart-card">
        <h3>Cascade de severite</h3>
        <div id="funnelWrap"></div>
      </div>
    </div>

    <div class="comparison-card">
      <h3 id="compTitle">Comparaison</h3>
      <div class="chart-wrap" id="compWrap" style="height:360px"><canvas id="compChart"></canvas></div>
    </div>
  </div>

  <footer>
    <span>Source : <a href="https://assurance-maladie.ameli.fr/etudes-et-donnees/risque-at-ctn-x-naf-serie-annuelle" target="_blank">Ameli, Risque AT par CTN x NAF 2023</a></span>
    <span>729 codes NAF5 &middot; 89 divisions</span>
  </footer>
</div>

<script>
/* __AT_DATA_INJECTION__ */

(function() {
  'use strict';

  // --- State ---
  let currentCode = null;
  let currentLevel = 'naf5';
  let causesChart = null;
  let compChart = null;
  let acIndex = -1;

  // --- Elements ---
  const searchInput = document.getElementById('searchInput');
  const acBox = document.getElementById('autocomplete');
  const resultsDiv = document.getElementById('results');
  const emptyState = document.getElementById('emptyState');
  const levelTabs = document.getElementById('levelTabs');

  // --- Chart defaults for dark theme ---
  Chart.defaults.color = '#8b949e';
  Chart.defaults.borderColor = '#2d333b';
  Chart.defaults.font.family = "'DM Sans', sans-serif";

  // --- Helpers ---
  function fmt(n) {
    if (n === undefined || n === null) return '-';
    const str = n.toLocaleString('fr-FR');
    // Replace narrow/non-breaking spaces with regular spaces (invisible in some fonts)
    return str.replace(/[\u202F\u00A0]/g, ' ');
  }

  function badgeHTML(secteur, national, invert) {
    if (!national || national === 0) return '';
    const pct = ((secteur - national) / national * 100);
    const sign = pct >= 0 ? '+' : '';
    let cls = pct > 5 ? 'up' : pct < -5 ? 'down' : 'neutral';
    if (invert) cls = cls === 'up' ? 'down' : cls === 'down' ? 'up' : 'neutral';
    return `<span class="badge ${cls}">${sign}${pct.toFixed(0)}% vs national</span>`;
  }

  function getStore(level) {
    return DATA['by_' + level];
  }

  function normalize(str) {
    return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
  }

  // --- Search & Autocomplete ---
  let debounceTimer;
  searchInput.addEventListener('input', function() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => showAutocomplete(this.value), 120);
  });

  searchInput.addEventListener('focus', function() {
    showAutocomplete(this.value);
  });

  searchInput.addEventListener('keydown', function(e) {
    const items = acBox.querySelectorAll('.ac-item');
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      acIndex = Math.min(acIndex + 1, items.length - 1);
      updateAcActive(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      acIndex = Math.max(acIndex - 1, 0);
      updateAcActive(items);
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (acIndex >= 0 && items[acIndex]) {
        items[acIndex].click();
      }
    } else if (e.key === 'Escape') {
      closeAc();
    }
  });

  function updateAcActive(items) {
    items.forEach((el, i) => el.classList.toggle('active', i === acIndex));
    if (items[acIndex]) items[acIndex].scrollIntoView({ block: 'nearest' });
  }

  // All NAF2 divisions sorted by code for the default browse list
  const defaultEntries = (function() {
    return Object.entries(DATA.by_naf2)
      .sort((a, b) => a[0].localeCompare(b[0]))
      .map(([code, v]) => ({ code, libelle: v.libelle, level: 'naf2' }));
  })();

  function showAutocomplete(query) {
    let matches;
    if (!query || query.length < 1) {
      matches = defaultEntries;
    } else {
      const q = normalize(query);
      const qUp = query.trim().toUpperCase();
      const isCodeSearch = /^[0-9]/.test(query.trim());
      matches = DATA.naf_index
        .filter(e => {
          if (isCodeSearch) return e.code.toUpperCase().startsWith(qUp);
          return normalize(e.code).includes(q) || normalize(e.libelle).includes(q);
        })
        .sort((a, b) => {
          // 1. Exact match first
          const aExact = a.code.toUpperCase() === qUp ? 0 : 1;
          const bExact = b.code.toUpperCase() === qUp ? 0 : 1;
          if (aExact !== bExact) return aExact - bExact;
          // 2. Active level first
          const aLevel = a.level === currentLevel ? 0 : 1;
          const bLevel = b.level === currentLevel ? 0 : 1;
          if (aLevel !== bLevel) return aLevel - bLevel;
          // 3. Code starts with query first
          const aStarts = a.code.toUpperCase().startsWith(qUp) ? 0 : 1;
          const bStarts = b.code.toUpperCase().startsWith(qUp) ? 0 : 1;
          if (aStarts !== bStarts) return aStarts - bStarts;
          // 4. Sort by code
          return a.code.localeCompare(b.code);
        })
        .slice(0, 20);
    }

    if (matches.length === 0) { closeAc(); return; }

    acBox.innerHTML = matches.map(m =>
      `<div class="ac-item" data-code="${m.code}" data-level="${m.level}">
        <span class="code">${m.code}</span>
        <span class="libelle">${m.libelle}</span>
        <span class="level-tag">${m.level.toUpperCase()}</span>
      </div>`
    ).join('');

    acBox.querySelectorAll('.ac-item').forEach(el => {
      el.addEventListener('click', function() {
        const code = this.dataset.code;
        const level = this.dataset.level;
        setLevel(level);
        selectCode(code, level);
        closeAc();
      });
    });

    acIndex = -1;
    acBox.classList.add('open');
  }

  function closeAc() {
    acBox.classList.remove('open');
    acIndex = -1;
  }

  document.addEventListener('click', function(e) {
    if (!e.target.closest('.search-wrapper')) closeAc();
  });

  // --- Level tabs ---
  levelTabs.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', function() {
      setLevel(this.dataset.level);
      if (currentCode) {
        const newCode = adaptCode(currentCode, currentLevel);
        if (newCode) selectCode(newCode, currentLevel);
      }
    });
  });

  function setLevel(level) {
    currentLevel = level;
    levelTabs.querySelectorAll('button').forEach(b =>
      b.classList.toggle('active', b.dataset.level === level)
    );
  }

  function adaptCode(code, targetLevel) {
    const store = getStore(targetLevel);
    // Direct match
    if (store[code]) return code;
    // Going up: truncate
    if (targetLevel === 'naf4' && code.length >= 4) return store[code.substring(0, 4)] ? code.substring(0, 4) : null;
    if (targetLevel === 'naf2') return store[code.substring(0, 2)] ? code.substring(0, 2) : null;
    // Going down: find first code starting with current prefix
    const match = Object.keys(store).find(k => k.startsWith(code));
    return match || null;
  }

  // --- Select & Render ---
  function selectCode(code, level) {
    currentCode = code;
    currentLevel = level;
    searchInput.value = code;
    window.location.hash = code;
    render(code, level);
  }

  function render(code, level) {
    const store = getStore(level);
    const entry = store[code];
    if (!entry) return;

    emptyState.style.display = 'none';
    resultsDiv.classList.add('visible');

    const s = entry.stats;
    const nat = DATA.meta.national;

    document.getElementById('selTitle').textContent = `${code} \u2014 ${entry.libelle}`;
    const levelLabel = level === 'naf5' ? 'Code NAF' : level === 'naf4' ? 'Sous-classe NAF' : 'Division NAF';
    let subText = levelLabel;
    if (entry.codes_naf5) subText += ` // ${entry.codes_naf5.length} codes NAF5 agreg\u00E9s`;
    document.getElementById('selSub').textContent = subText;

    // Breadcrumb: NAF2 > NAF4 > NAF5
    const bc = document.getElementById('breadcrumb');
    const crumbs = [];
    const naf2code = code.substring(0, 2);
    const naf4code = code.substring(0, 4);
    const naf2entry = DATA.by_naf2[naf2code];
    const naf4entry = DATA.by_naf4[naf4code];
    if (level === 'naf5') {
      if (naf2entry) crumbs.push({ code: naf2code, label: `${naf2code} ${naf2entry.libelle}`, level: 'naf2' });
      if (naf4entry) crumbs.push({ code: naf4code, label: `${naf4code} ${naf4entry.libelle}`, level: 'naf4' });
      crumbs.push({ label: `${code}`, current: true });
    } else if (level === 'naf4') {
      if (naf2entry) crumbs.push({ code: naf2code, label: `${naf2code} ${naf2entry.libelle}`, level: 'naf2' });
      crumbs.push({ label: `${code}`, current: true });
    } else {
      crumbs.push({ label: `${code}`, current: true });
    }
    bc.innerHTML = crumbs.map((c, i) => {
      const sep = i < crumbs.length - 1 ? '<span class="sep">&rsaquo;</span>' : '';
      if (c.current) return `<span class="current">${c.label}</span>`;
      return `<a data-code="${c.code}" data-level="${c.level}">${c.label}</a>${sep}`;
    }).join('');
    bc.querySelectorAll('a[data-code]').forEach(a => {
      a.addEventListener('click', function() {
        setLevel(this.dataset.level);
        selectCode(this.dataset.code, this.dataset.level);
      });
    });

    // Compute AT ranking at current level
    const allAtLevel = Object.entries(getStore(level))
      .map(([k, v]) => ({ code: k, at: v.stats.at_1er_reglement }))
      .sort((a, b) => b.at - a.at);
    const rank = allAtLevel.findIndex(e => e.code === code) + 1;
    const total = allAtLevel.length;
    const pctile = Math.round(rank / total * 100);
    const rankBadge = `<span class="badge neutral">#${rank}</span>`;

    const kpis = [
      { label: 'Accidents du travail', value: fmt(s.at_1er_reglement), badge: rankBadge },
      { label: 'Indice de frequence', value: fmt(s.indice_frequence), badge: badgeHTML(s.indice_frequence, nat.indice_frequence) },
      { label: 'Taux de gravite', value: fmt(s.taux_gravite), badge: badgeHTML(s.taux_gravite, nat.taux_gravite) },
    ];

    document.getElementById('kpiGrid').innerHTML = kpis.map(k =>
      `<div class="kpi-card">
        <div class="label">${k.label}</div>
        <div class="value">${k.value}</div>
        ${k.badge}
      </div>`
    ).join('');

    renderInsights(s, nat, entry.risk_causes);
    renderPositionStrip(code, level, s.indice_frequence);
    renderCausesChart(entry.risk_causes);
    renderFunnelChart(s);
    // Hide comparison at NAF2 level (no meaningful parent grouping)
    const compCard = document.querySelector('.comparison-card');
    if (level === 'naf2') {
      compCard.style.display = 'none';
    } else {
      compCard.style.display = '';
      renderComparisonChart(code, level);
    }
  }

  // --- Charts ---
  const CAUSE_COLORS = [
    '#7c6ef0','#4e9af5','#3fb950','#e8bc6a',
    '#e5534b','#d94fa0','#5bc0be','#f0883e'
  ];

  function renderInsights(s, nat, causes) {
    const insights = [];

    // IF vs national
    const ifRatio = s.indice_frequence / nat.indice_frequence;
    if (ifRatio >= 3) {
      insights.push({ level: 'danger', text: `Indice de frequence ${ifRatio.toFixed(1)}x la moyenne nationale` });
    } else if (ifRatio >= 2) {
      insights.push({ level: 'danger', text: `IF ${ifRatio.toFixed(1)}x au-dessus de la moyenne nationale` });
    } else if (ifRatio >= 1.3) {
      insights.push({ level: 'warn', text: `IF ${Math.round((ifRatio - 1) * 100)}% au-dessus de la moyenne nationale` });
    } else if (ifRatio <= 0.5) {
      insights.push({ level: 'info', text: `IF 2x en dessous de la moyenne nationale` });
    }

    // Taux de gravite vs national
    const tgRatio = s.taux_gravite / nat.taux_gravite;
    if (tgRatio >= 2) {
      insights.push({ level: 'danger', text: `Gravite ${tgRatio.toFixed(1)}x la moyenne nationale` });
    } else if (tgRatio >= 1.3) {
      insights.push({ level: 'warn', text: `Gravite ${Math.round((tgRatio - 1) * 100)}% au-dessus de la moyenne` });
    }

    // IP rate
    const ipRate = s.at_1er_reglement > 0 ? (s.nouvelles_ip / s.at_1er_reglement * 100) : 0;
    if (ipRate >= 5) {
      insights.push({ level: 'danger', text: `${ipRate.toFixed(1)}% des AT menent a une incapacite permanente` });
    } else if (ipRate >= 3) {
      insights.push({ level: 'warn', text: `${ipRate.toFixed(1)}% des AT menent a une incapacite permanente` });
    }

    // Deces
    if (s.deces > 0) {
      insights.push({ level: 'danger', text: `${s.deces} deces enregistre${s.deces > 1 ? 's' : ''} en 2023` });
    }

    // Dominant cause
    const sorted = Object.entries(causes).filter(([,v]) => v > 0).sort((a, b) => b[1] - a[1]);
    if (sorted.length > 0 && sorted[0][1] >= 35) {
      insights.push({ level: 'warn', text: `${sorted[0][0]} = ${sorted[0][1].toFixed(0)}% des accidents` });
    }

    // High volume
    if (s.at_1er_reglement >= 10000) {
      insights.push({ level: 'info', text: `${fmt(s.at_1er_reglement)} AT, secteur a fort volume` });
    }

    const icons = { danger: '\u26A0', warn: '\u25C9', info: '\u2139' };
    document.getElementById('insightsPanel').innerHTML = insights.map(i =>
      `<div class="insight ${i.level}"><span class="insight-icon">${icons[i.level]}</span>${i.text}</div>`
    ).join('');
  }

  function renderPositionStrip(code, level, ifValue) {
    const store = getStore(level);
    const allIF = Object.entries(store)
      .map(([k, v]) => ({ code: k, libelle: v.libelle, if_val: v.stats.indice_frequence }))
      .filter(d => d.if_val > 0)
      .sort((a, b) => a.if_val - b.if_val);

    const maxIF = allIF[allIF.length - 1].if_val;
    const levelLabel = level === 'naf5' ? 'NAF5' : level === 'naf4' ? 'NAF4' : 'NAF2';
    document.getElementById('posTitle').textContent =
      `Positionnement IF // ${allIF.length} codes ${levelLabel}`;

    const strip = document.getElementById('posStrip');
    let html = '<div class="pos-track"></div><div class="pos-tip" id="posTip"></div>';

    // Peer dots
    allIF.forEach((d, i) => {
      const x = (d.if_val / maxIF * 96) + 2;
      const isCurrent = d.code === code;
      html += `<div class="pos-dot${isCurrent ? ' current' : ''}" style="left:${x}%" data-idx="${i}"></div>`;
      if (isCurrent) {
        html += `<div class="pos-marker-label" style="left:${x}%">IF ${ifValue.toFixed(1)}</div>`;
      }
    });

    // National average marker
    const natIF = DATA.meta.national.indice_frequence;
    const natX = (natIF / maxIF * 96) + 2;
    html += `<div class="pos-national" style="left:${natX}%"></div>`;
    html += `<div class="pos-national-label" style="left:${natX}%">Moy. ${natIF.toFixed(1)}</div>`;

    // Axis labels
    const minIF = allIF[0].if_val;
    html += `<div class="pos-axis" style="left:2%">${minIF.toFixed(0)}</div>`;
    html += `<div class="pos-axis pos-end">${maxIF.toFixed(0)}</div>`;

    strip.innerHTML = html;

    // Tooltip + click
    const tip = document.getElementById('posTip');
    strip.querySelectorAll('.pos-dot:not(.current)').forEach(dot => {
      const d = allIF[+dot.dataset.idx];
      dot.addEventListener('mouseenter', function() {
        const short = d.libelle.length > 30 ? d.libelle.substring(0, 30) + '...' : d.libelle;
        tip.textContent = `${d.code}  ${short}  IF ${d.if_val.toFixed(1)}`;
        tip.style.left = dot.style.left;
        tip.classList.add('visible');
      });
      dot.addEventListener('mouseleave', function() {
        tip.classList.remove('visible');
      });
      dot.addEventListener('click', function() {
        tip.classList.remove('visible');
        selectCode(d.code, level);
      });
    });
  }

  function renderCausesChart(causes) {
    const sorted = Object.entries(causes)
      .filter(([,v]) => v > 0)
      .sort((a,b) => b[1] - a[1]);

    // Show top 6, lump the rest into "Autres"
    const MAX = 6;
    let chartData;
    if (sorted.length > MAX) {
      const top = sorted.slice(0, MAX);
      const rest = sorted.slice(MAX).reduce((sum, [,v]) => sum + v, 0);
      chartData = [...top, ['Autres', rest]];
    } else {
      chartData = sorted;
    }

    const labels = chartData.map(([k]) => k);
    const values = chartData.map(([,v]) => v);

    if (causesChart) causesChart.destroy();
    causesChart = new Chart(document.getElementById('causesChart'), {
      type: 'doughnut',
      data: {
        labels,
        datasets: [{
          data: values,
          backgroundColor: CAUSE_COLORS.slice(0, values.length),
          borderColor: '#161b22',
          borderWidth: 2,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '55%',
        plugins: {
          legend: {
            position: 'left',
            align: 'center',
            labels: {
              padding: 10,
              usePointStyle: true,
              pointStyle: 'circle',
              font: { size: 11, family: "'DM Sans', sans-serif" },
              color: '#8b949e',
              generateLabels: function(chart) {
                const data = chart.data;
                return data.labels.map((label, i) => ({
                  text: label + ' \u2013 ' + data.datasets[0].data[i].toFixed(0) + '%',
                  fillStyle: data.datasets[0].backgroundColor[i],
                  fontColor: '#8b949e',
                  strokeStyle: 'transparent',
                  pointStyle: 'circle',
                  index: i,
                  hidden: !chart.getDataVisibility(i),
                }));
              }
            }
          },
          tooltip: {
            backgroundColor: '#1c2128',
            borderColor: '#2d333b',
            borderWidth: 1,
            titleFont: { family: "'JetBrains Mono', monospace", size: 11 },
            bodyFont: { family: "'JetBrains Mono', monospace", size: 11 },
            callbacks: { label: ctx => ` ${ctx.label}: ${ctx.parsed.toFixed(1)}%` }
          }
        }
      },
      plugins: []
    });
  }

  function renderFunnelChart(s) {
    const items = [
      { label: 'Deces',                    value: s.deces || 0,             color: '#c74a43' },
      { label: 'Incapacites permanentes', value: s.nouvelles_ip || 0,      color: '#d4a043' },
      { label: 'AT avec arret 4j+',       value: s.at_4j_arret || 0,      color: '#4e8ac5' },
      { label: 'AT en 1er reglement',     value: s.at_1er_reglement || 0,  color: '#6a5ec8' },
    ];

    const maxVal = items[items.length - 1].value || 1;
    const wrap = document.getElementById('funnelWrap');

    const bars = items.map((d, i) => {
      // Fixed tiers: each step visually distinct, numbers tell the data story
      const tierWidths = [22, 46, 74, 100];
      const pct = tierWidths[i] || 100;
      const ofTotal = (d.value / maxVal * 100).toFixed(1);
      return `<div class="funnel-bar" style="width:${pct}%;background:${d.color}" data-idx="${i}" data-pct="${ofTotal}">
        <span class="funnel-bar-label">${d.label}</span>
        <span class="funnel-bar-value">${fmt(d.value)}</span>
      </div>`;
    }).join('');

    wrap.style.position = 'relative';
    wrap.innerHTML = `<div class="funnel">${bars}</div><div class="funnel-tooltip" id="funnelTip"></div>`;

    const tip = document.getElementById('funnelTip');
    wrap.querySelectorAll('.funnel-bar').forEach(bar => {
      const i = +bar.dataset.idx;
      const d = items[i];
      const pctText = i === items.length - 1 ? '100% des AT' : bar.dataset.pct + '% des AT';
      bar.addEventListener('mouseenter', function(e) {
        tip.innerHTML = pctText;
        tip.classList.add('visible');
      });
      bar.addEventListener('mousemove', function(e) {
        const rect = wrap.getBoundingClientRect();
        tip.style.left = (e.clientX - rect.left + 12) + 'px';
        tip.style.top = (e.clientY - rect.top - 32) + 'px';
      });
      bar.addEventListener('mouseleave', function() {
        tip.classList.remove('visible');
      });
    });
  }

  function renderComparisonChart(code, level) {
    let siblings = [];
    const store = getStore(level);

    if (level === 'naf5') {
      const naf4 = code.substring(0, 4);
      siblings = Object.entries(store)
        .filter(([k]) => k.startsWith(naf4))
        .map(([k, v]) => ({ code: k, libelle: v.libelle, if_val: v.stats.indice_frequence }));
      document.getElementById('compTitle').textContent =
        `Comparaison NAF5 // ${naf4}`;
    } else if (level === 'naf4') {
      const naf2 = code.substring(0, 2);
      siblings = Object.entries(store)
        .filter(([k, v]) => v.naf2 === naf2)
        .map(([k, v]) => ({ code: k, libelle: v.libelle, if_val: v.stats.indice_frequence }));
      document.getElementById('compTitle').textContent =
        `Comparaison NAF4 // division ${naf2}`;
    } else {
      siblings = Object.entries(store)
        .map(([k, v]) => ({ code: k, libelle: v.libelle, if_val: v.stats.indice_frequence }));
      document.getElementById('compTitle').textContent =
        `Comparaison NAF2 // toutes divisions`;
    }

    siblings.sort((a, b) => b.if_val - a.if_val);
    let top = siblings.slice(0, 10);
    if (!top.find(s => s.code === code)) {
      const current = siblings.find(s => s.code === code);
      if (current) { top.pop(); top.push(current); top.sort((a,b) => b.if_val - a.if_val); }
    }

    const labels = top.map(s => `${s.code}  ${s.libelle}`.substring(0, 40));
    const values = top.map(s => s.if_val);
    const colors = top.map(s => s.code === code ? '#d4a043' : '#2d333b');
    const borderColors = top.map(s => s.code === code ? '#d4a043' : '#373e47');

    if (compChart) compChart.destroy();
    compChart = new Chart(document.getElementById('compChart'), {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          data: values,
          backgroundColor: colors,
          borderColor: borderColors,
          borderWidth: 1,
          borderRadius: 1,
          barThickness: 22,
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: '#1c2128',
            borderColor: '#2d333b',
            borderWidth: 1,
            titleFont: { family: "'JetBrains Mono', monospace", size: 11 },
            bodyFont: { family: "'JetBrains Mono', monospace", size: 11 },
            callbacks: { label: ctx => ` IF: ${ctx.parsed.x.toFixed(1)}` }
          }
        },
        scales: {
          x: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Indice de frequence',
              font: { family: "'JetBrains Mono', monospace", size: 10, weight: '500' },
              color: '#545d68'
            },
            ticks: { font: { family: "'JetBrains Mono', monospace", size: 10 } },
            grid: { color: 'rgba(45,51,59,0.5)' }
          },
          y: {
            grid: { display: false },
            ticks: { font: { size: 11 } }
          }
        }
      }
    });
    document.getElementById('compWrap').style.height =
      Math.max(200, top.length * 34 + 60) + 'px';
  }

  // --- URL hash ---
  function loadFromHash() {
    const hash = window.location.hash.replace('#', '').trim();
    if (!hash) return;

    for (const level of ['naf5', 'naf4', 'naf2']) {
      if (getStore(level)[hash]) {
        setLevel(level);
        selectCode(hash, level);
        return;
      }
    }
    const upper = hash.toUpperCase();
    for (const level of ['naf5', 'naf4', 'naf2']) {
      if (getStore(level)[upper]) {
        setLevel(level);
        selectCode(upper, level);
        return;
      }
    }
  }

  // --- Clickable examples in empty state ---
  document.querySelectorAll('.naf-row[data-code],.naf-example[data-code]').forEach(el => {
    el.addEventListener('click', function() {
      const code = (this.closest('.naf-row') || this).querySelector('.naf-example')?.dataset.code || this.dataset.code;
      if (!code) return;
      for (const level of ['naf5', 'naf4', 'naf2']) {
        if (getStore(level)[code]) { setLevel(level); selectCode(code, level); return; }
      }
    });
  });
  // Make entire row clickable
  document.querySelectorAll('.naf-row').forEach(row => {
    const ex = row.querySelector('.naf-example');
    if (ex) row.addEventListener('click', () => {
      const code = ex.dataset.code;
      for (const level of ['naf5', 'naf4', 'naf2']) {
        if (getStore(level)[code]) { setLevel(level); selectCode(code, level); return; }
      }
    });
  });

  // --- Keyboard shortcut: / to focus search ---
  document.addEventListener('keydown', function(e) {
    if (e.key === '/' && !e.ctrlKey && !e.metaKey && document.activeElement !== searchInput) {
      e.preventDefault();
      searchInput.focus();
      searchInput.select();
    }
  });

  window.addEventListener('hashchange', loadFromHash);
  loadFromHash();

})();
</script>
</body>
</html>
